<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Das Duell um die Geld</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* Slate 900 */
            color: #e2e8f0; /* Slate 200 */
            overflow-y: auto; 
            -webkit-tap-highlight-color: transparent;
        }

        .fade-in { animation: fadeIn 0.4s ease-out; }
        .slide-up { animation: slideUp 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .glass-panel {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Buttons & Interactions */
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            transition: transform 0.1s, filter 0.2s;
        }
        .btn-primary:active { transform: scale(0.97); }

        .btn-confirm {
            background: linear-gradient(135deg, #d97706, #b45309);
            transition: transform 0.1s, filter 0.2s;
        }
        .btn-confirm:active { transform: scale(0.97); }

        .btn-secondary {
            background: rgba(51, 65, 85, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.2s;
        }
        .btn-secondary:active { background: rgba(51, 65, 85, 0.8); }

        .btn-info {
            background: rgba(16, 185, 129, 0.15); 
            border: 1px solid rgba(16, 185, 129, 0.4);
            color: #34d399;
            transition: all 0.2s;
        }
        .btn-info:active { transform: scale(0.95); background: rgba(16, 185, 129, 0.25); }

        /* Reveal Box Styles */
        .reveal-box { transition: all 0.3s ease; }
        
        .state-locked {
            opacity: 0.5;
            filter: grayscale(100%);
            cursor: not-allowed;
            background: rgba(15, 23, 42, 0.4);
            border: 1px solid rgba(255,255,255,0.05);
        }

        .state-loading {
            opacity: 0.4;
            pointer-events: none;
            filter: grayscale(80%);
        }

        .state-covered {
            cursor: pointer;
            background: rgba(30, 41, 59, 0.4);
            border: 1px dashed #3b82f6;
        }
        .state-covered:active {
            background: rgba(30, 41, 59, 0.8);
            transform: scale(0.99);
        }
        
        .state-confirming {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid #eab308;
        }

        .state-revealed {
            background: rgba(30, 41, 59, 0.9);
            border: 1px solid rgba(255,255,255,0.2);
            cursor: default;
        }
        .state-revealed.is-answer {
            background: rgba(22, 101, 52, 0.2);
            border-color: rgba(34, 197, 94, 0.5);
        }

        /* Custom Select Styling */
        .custom-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2394a3b8' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 2px; }

        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-[100dvh] flex flex-col bg-[#0f172a]">

    <!-- Main Content -->
    <main class="flex-1 relative p-4 md:p-8 w-full flex flex-col items-center justify-start min-h-0">

        <!-- START / API CHECK MODAL -->
        <div id="start-modal" class="fixed inset-0 z-[60] bg-slate-950 flex items-center justify-center p-4 fade-in">
            <div class="glass-panel w-full max-w-md rounded-2xl shadow-2xl flex flex-col border border-slate-700 p-8 relative overflow-hidden">
                <div class="absolute top-0 left-1/2 -translate-x-1/2 w-full h-32 bg-blue-500/20 blur-3xl pointer-events-none"></div>

                <div class="relative z-10 text-center">
                    <div class="mx-auto w-16 h-16 bg-blue-600/20 rounded-2xl flex items-center justify-center mb-6 border border-blue-500/30">
                        <i data-lucide="key" class="w-8 h-8 text-blue-400"></i>
                    </div>
                    
                    <h2 class="text-2xl font-bold text-white mb-2">Willkommen!</h2>
                    <p class="text-slate-400 text-sm mb-8">Bitte gib deinen Gemini API Key ein, um live generierte Fragen zu erhalten.</p>

                    <div class="space-y-4">
                        <div class="text-left">
                            <label class="text-xs font-bold text-slate-500 uppercase tracking-wider ml-1 mb-2 block">API Key</label>
                            <div class="relative">
                                <input type="password" id="startApiKeyInput" class="w-full bg-slate-900/80 border border-slate-700 text-white text-sm rounded-xl p-4 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none font-mono transition-all placeholder-slate-600" placeholder="AIzaSy...">
                                <div id="apiStatusIcon" class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-500">
                                    <i data-lucide="lock" class="w-4 h-4"></i>
                                </div>
                            </div>
                            <p id="apiErrorMsg" class="text-red-400 text-xs mt-2 hidden flex items-center gap-1"><i data-lucide="alert-circle" class="w-3 h-3"></i> <span>Verbindung fehlgeschlagen</span></p>
                        </div>

                        <button onclick="verifyKeyOnly()" id="btnVerify" class="btn-primary w-full py-4 rounded-xl font-bold text-white shadow-lg flex items-center justify-center gap-2 group">
                            <span>Weiter zum Setup</span>
                            <i data-lucide="arrow-right" class="w-5 h-5 group-hover:translate-x-1 transition-transform"></i>
                        </button>

                        <div class="relative py-2">
                            <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-slate-800"></div></div>
                            <div class="relative flex justify-center text-xs uppercase"><span class="bg-slate-900/0 px-2 text-slate-600 font-bold bg-[#151d2e]">oder</span></div>
                        </div>

                        <button onclick="startOffline()" class="btn-secondary w-full py-3 rounded-xl font-medium text-slate-300 text-sm hover:text-white">
                            Ohne KI spielen (Offline-Modus)
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- SETUP MODAL (Step 2) -->
        <div id="setup-modal" class="hidden fixed inset-0 z-[60] bg-slate-950 flex items-center justify-center p-4 fade-in">
            <div class="glass-panel w-full max-w-md rounded-2xl shadow-2xl flex flex-col border border-slate-700 p-8 relative overflow-hidden">
                <div class="relative z-10 text-center">
                    <div class="mx-auto w-16 h-16 bg-orange-600/20 rounded-2xl flex items-center justify-center mb-6 border border-orange-500/30">
                        <i data-lucide="sliders" class="w-8 h-8 text-orange-400"></i>
                    </div>
                    
                    <h2 class="text-2xl font-bold text-white mb-2">Spiel-Setup</h2>
                    <p class="text-slate-400 text-sm mb-8">WÃ¤hle deine Start-Einstellungen.</p>

                    <div class="space-y-6 text-left">
                        <div>
                            <label class="text-xs font-bold text-slate-500 uppercase tracking-wider ml-1 mb-2 block">Kategorie</label>
                            <select id="setupCategorySelect" class="custom-select w-full appearance-none bg-slate-900/80 border border-slate-700 text-white text-sm rounded-xl p-4 focus:ring-2 focus:ring-blue-500 outline-none font-medium">
                                <!-- Options filled by JS -->
                            </select>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-slate-500 uppercase tracking-wider ml-1 mb-2 block">Schwierigkeit</label>
                            <select id="setupDifficultySelect" class="custom-select w-full appearance-none bg-slate-900/80 border border-slate-700 text-white text-sm rounded-xl p-4 focus:ring-2 focus:ring-blue-500 outline-none font-medium">
                                <option value="random" selected>ðŸŽ² ZufÃ¤llig</option>
                                <option disabled>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</option>
                                <option value="leicht">ðŸŸ¢ Leicht</option>
                                <option value="mittel">ðŸŸ¡ Mittel</option>
                                <option value="schwer">ðŸ”´ Schwer</option>
                                <option value="experte">ðŸŸ£ Experte</option>
                            </select>
                        </div>

                        <button onclick="confirmSetupAndStart()" class="btn-primary w-full py-4 rounded-xl font-bold text-white shadow-lg flex items-center justify-center gap-2 group mt-4">
                            <span>Spiel starten</span>
                            <i data-lucide="play" class="w-5 h-5 group-hover:scale-110 transition-transform"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- INFO / PROOF MODAL -->
        <div id="info-modal" class="hidden fixed inset-0 z-[70] bg-slate-950/90 flex items-center justify-center p-4 fade-in backdrop-blur-sm">
            <div class="glass-panel w-full max-w-lg rounded-2xl shadow-2xl flex flex-col border border-slate-700 p-6 relative">
                <div class="flex justify-between items-start mb-4">
                    <h3 class="text-xl font-bold text-white flex items-center gap-2">
                        <i data-lucide="info" class="w-6 h-6 text-green-400"></i> Wissenswertes
                    </h3>
                    <button onclick="closeInfo()" class="p-1 rounded-full hover:bg-slate-700 text-slate-400">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                <div id="info-content" class="text-slate-300 leading-relaxed text-sm md:text-base">
                    Lade Info...
                </div>
                <div class="mt-6 text-right">
                    <button onclick="closeInfo()" class="px-4 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 text-white text-sm font-bold transition-colors">SchlieÃŸen</button>
                </div>
            </div>
        </div>

        <!-- SETTINGS MODAL (API Key Change) -->
        <div id="settings-modal" class="hidden fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4 fade-in backdrop-blur-sm">
            <div class="glass-panel w-full max-w-md rounded-2xl shadow-2xl flex flex-col max-h-[90dvh] overflow-hidden border border-slate-700">
                <div class="p-5 border-b border-slate-700 flex justify-between items-center bg-slate-900/50">
                    <h2 class="text-lg font-bold text-white flex items-center gap-2"><i data-lucide="key" class="w-5 h-5 text-blue-400"></i> API Einstellungen</h2>
                    <button onclick="toggleSettings()" class="p-1 rounded-full hover:bg-slate-700 text-slate-400"><i data-lucide="x" class="w-6 h-6"></i></button>
                </div>
                <div class="p-5 space-y-4">
                    <label class="block text-xs text-slate-400 mb-1">API Key</label>
                    <input type="password" id="apiKeyInput" class="w-full bg-slate-800 border border-slate-600 text-white text-xs rounded-lg p-3 font-mono mb-2" placeholder="AIzaSy..." onchange="saveSettings()">
                    <p class="text-[10px] text-slate-500">Der Key wird lokal im Browser gespeichert.</p>
                </div>
                <div class="p-4 border-t border-slate-700 bg-slate-900/80">
                    <button onclick="toggleSettings()" class="w-full py-3 rounded-xl bg-blue-600 hover:bg-blue-500 text-white font-bold text-sm shadow-lg">SchlieÃŸen</button>
                </div>
            </div>
        </div>

        <!-- GAME AREA (Initially Hidden) -->
        <div id="game-container" class="w-full max-w-2xl flex flex-col gap-6 pb-20 hidden opacity-0 transition-opacity duration-500">
            
            <!-- HEADER -->
            <header class="w-full flex justify-between items-center mb-2">
                <div class="flex items-center gap-3">
                    <div class="bg-blue-600/20 p-2 rounded-xl">
                        <i data-lucide="brain-circuit" class="w-6 h-6 text-blue-400"></i>
                    </div>
                    <h1 class="font-bold text-xl text-slate-100 tracking-tight">Das Duell um die Geld</h1>
                </div>
                <button onclick="toggleSettings()" class="p-2.5 rounded-xl bg-slate-800 hover:bg-slate-700 text-slate-300 transition-colors border border-slate-700" title="API Key Ã¤ndern">
                    <i data-lucide="key" class="w-5 h-5"></i>
                </button>
            </header>

            <!-- ALWAYS VISIBLE CONTROLS -->
            <div class="glass-panel p-4 rounded-2xl border border-slate-700 flex flex-col sm:flex-row gap-3 shadow-lg">
                <div class="flex-1">
                    <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1.5 block ml-1">Kategorie</label>
                    <select id="categorySelect" onchange="updateSettings('category')" class="custom-select w-full appearance-none bg-slate-800 border border-slate-600 text-white text-sm rounded-xl focus:ring-2 focus:ring-blue-500 block p-2.5 font-medium transition-all hover:border-slate-500">
                        <!-- Options filled by JS -->
                    </select>
                </div>
                <div class="flex-1 sm:flex-[0.6]">
                    <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1.5 block ml-1">Schwierigkeit</label>
                    <select id="difficultySelect" onchange="updateSettings('difficulty')" class="custom-select w-full appearance-none bg-slate-800 border border-slate-600 text-white text-sm rounded-xl focus:ring-2 focus:ring-blue-500 block p-2.5 font-medium transition-all hover:border-slate-500">
                        <option value="random" selected>ðŸŽ² ZufÃ¤llig</option>
                        <option disabled>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</option>
                        <option value="leicht">ðŸŸ¢ Leicht</option>
                        <option value="mittel">ðŸŸ¡ Mittel</option>
                        <option value="schwer">ðŸ”´ Schwer</option>
                        <option value="experte">ðŸŸ£ Experte</option>
                    </select>
                </div>
            </div>

            <!-- Question Card Container -->
            <div class="relative">
                <!-- Loading Overlay -->
                <div id="loading-overlay" class="hidden absolute inset-0 z-30 flex flex-col items-center justify-center bg-slate-900/90 backdrop-blur-sm rounded-3xl transition-all duration-300">
                    <div class="w-10 h-10 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                    <div class="text-blue-400 font-bold animate-pulse">Generiere Frage...</div>
                </div>

                <!-- Question Card -->
                <div class="glass-panel rounded-3xl p-6 md:p-10 shadow-2xl relative overflow-hidden slide-up">
                    <!-- Header Badges -->
                    <div class="flex flex-wrap items-center gap-2 mb-4 relative z-10">
                        <span id="categoryBadge" class="px-3 py-1 bg-blue-500/10 text-blue-300 rounded-lg text-[10px] font-bold tracking-wider uppercase border border-blue-500/20">...</span>
                        <span id="difficultyBadge" class="px-3 py-1 bg-orange-500/10 text-orange-300 rounded-lg text-[10px] font-bold tracking-wider uppercase border border-orange-500/20">...</span>
                        <span id="liveBadge" class="hidden px-3 py-1 bg-green-500/10 text-green-300 rounded-lg text-[10px] font-bold tracking-wider uppercase border border-green-500/20 flex items-center gap-1"><i data-lucide="zap" class="w-3 h-3"></i> AI</span>
                    </div>

                    <!-- Question Text -->
                    <h2 id="questionText" class="text-xl md:text-3xl font-bold leading-tight mb-3 text-white relative z-10 drop-shadow-lg">
                        Lade Frage...
                    </h2>
                    
                    <!-- UNIT DISPLAY -->
                    <div class="relative z-10 flex items-center gap-2">
                        <span class="px-3 py-1.5 bg-slate-700/50 border border-slate-600 rounded-lg text-slate-300 text-xs font-bold tracking-widest uppercase">
                            Gesucht: <span id="questionUnit" class="text-blue-300 ml-1">...</span>
                        </span>
                    </div>

                    <!-- Decoration -->
                    <div class="absolute top-0 right-0 p-6 opacity-5 pointer-events-none">
                        <i data-lucide="help-circle" class="w-32 h-32"></i>
                    </div>
                </div>
            </div>

            <!-- Reveal Stack -->
            <div class="flex flex-col gap-4 slide-up" style="animation-delay: 0.1s;">
                
                <!-- HINT 1 -->
                <div id="box-h1" class="reveal-box state-covered rounded-2xl p-1" onclick="handleInteraction(1)">
                    <div class="relative overflow-hidden rounded-xl min-h-[80px] flex items-center justify-center">
                        <!-- Overlay Content -->
                        <div class="overlay absolute inset-0 flex items-center justify-center z-10 transition-opacity duration-300">
                            <span class="flex items-center gap-2 font-bold text-blue-400">
                                <i data-lucide="lightbulb" class="w-5 h-5"></i> Tipp 1 aufdecken
                            </span>
                        </div>
                        <!-- Real Content -->
                        <div class="content opacity-0 transform translate-y-4 transition-all duration-500 p-6 text-center text-slate-200 font-medium">
                            <span id="text-h1">...</span>
                        </div>
                    </div>
                </div>

                <!-- HINT 2 -->
                <div id="box-h2" class="reveal-box state-locked rounded-2xl p-1" onclick="handleInteraction(2)">
                    <div class="relative overflow-hidden rounded-xl min-h-[80px] flex items-center justify-center">
                        <div class="overlay absolute inset-0 flex items-center justify-center z-10">
                            <span class="flex items-center gap-2 font-bold text-slate-500">
                                <i data-lucide="lock" class="w-5 h-5"></i> Tipp 2
                            </span>
                        </div>
                        <div class="content opacity-0 transform translate-y-4 transition-all duration-500 p-6 text-center text-slate-200 font-medium">
                            <span id="text-h2">...</span>
                        </div>
                    </div>
                </div>

                <!-- ANSWER -->
                <div id="box-ans" class="reveal-box state-locked rounded-2xl p-1" onclick="handleInteraction(3)">
                    <div class="relative overflow-hidden rounded-xl min-h-[100px] flex items-center justify-center">
                        <div class="overlay absolute inset-0 flex items-center justify-center z-10">
                            <span class="flex items-center gap-2 font-bold text-slate-500">
                                <i data-lucide="lock" class="w-5 h-5"></i> Antwort
                            </span>
                        </div>
                        <div class="content opacity-0 transform translate-y-4 transition-all duration-500 p-6 text-center relative w-full">
                            <div class="text-xs uppercase tracking-widest text-green-400 font-bold mb-1">LÃ¶sung</div>
                            <div id="text-ans" class="text-2xl md:text-3xl font-black text-white">...</div>
                            
                            <!-- Info Button -->
                            <button onclick="showInfo(event)" id="info-btn" class="absolute right-0 top-1/2 -translate-y-1/2 btn-info p-2 rounded-full hidden md:mr-4 mr-0" title="ErklÃ¤rung anzeigen">
                                <i data-lucide="info" class="w-6 h-6"></i>
                            </button>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Controls -->
            <div class="mt-4 slide-up pb-10" style="animation-delay: 0.2s;">
                <button id="btn-next" onclick="nextQuestion()" class="btn-primary w-full py-4 rounded-xl font-bold text-lg shadow-lg flex items-center justify-center gap-2 text-white">
                    NÃ¤chste Frage <i data-lucide="arrow-right" class="w-5 h-5"></i>
                </button>
            </div>

        </div>

    </main>

    <script>
        // --- LOGIC & STATE ---
        
        const CATEGORIES = [
            "Allgemeines", "Geschichte", "Natur", "Geografie", "SÃ¼dtirol", 
            "Universum", "Wissenschaft", "Games", "Promis", "Lustiges", 
            "Sport", "Technik", "Film", "Tiere", "Musik", 
            "Essen", "Kunst", "Wirtschaft", "Architektur", "Literatur"
        ];
        
        const offlinePool = [
            { 
                c: "SÃ¼dtirol", 
                q: "Wie hoch ist der Ortler?", 
                h1: "Er Ã¼berragt die Zugspitze deutlich.", 
                h2: "Es fehlen nur knapp 100 Meter zur 4000er Marke.", 
                a: "3.905 Meter", 
                u: "Meter", 
                info: "Der Ortler ist der hÃ¶chste Berg der italienischen Provinz SÃ¼dtirol und der Region Trentino-SÃ¼dtirol. Er wurde erstmals 1804 bestiegen." 
            },
            { 
                c: "Games", 
                q: "Wann erschien das erste Super Mario Bros. in Japan?", 
                h1: "Es war in der Mitte des Jahrzehnts der Neonfarben und Vokuhilas.", 
                h2: "Im selben Jahr wurde Boris Becker mit 17 Jahren Wimbledonsieger.", 
                a: "1985", 
                u: "Jahr", 
                info: "Super Mario Bros. revolutionierte das Jump-â€™nâ€™-Run-Genre und rettete den Videospielmarkt nach dem 'Video Game Crash' von 1983." 
            },
            { 
                c: "Natur", 
                q: "Wie viele Beine hat ein 'TausendfÃ¼ÃŸler' maximal wirklich?", 
                h1: "Der Name ist eine Ãœbertreibung â€“ die meisten haben viel weniger.", 
                h2: "Die Rekordhalter haben etwa so viele Beine wie zwei Jahre Tage haben.", 
                a: "750 Beine", 
                u: "Anzahl Beine", 
                info: "Lange Zeit galt 750 als Maximum. Erst 2021 wurde eine neue Art (Eumillipes persephone) mit 1306 Beinen entdeckt â€“ unsere Frage bezieht sich aber auf den klassischen 'Rekordhalter' der SchulbÃ¼cher." 
            },
            { 
                c: "Geografie", 
                q: "Wie lang ist der Nil?", 
                h1: "Er ist einer der zwei lÃ¤ngsten FlÃ¼sse der Erde.", 
                h2: "Er ist lÃ¤nger als die Strecke von Lissabon nach Moskau.", 
                a: "6.650 km", 
                u: "Kilometer", 
                info: "Der Nil gilt meist als der lÃ¤ngste Fluss der Erde, obwohl neuere Messungen den Amazonas manchmal favorisieren. Er flieÃŸt durch elf LÃ¤nder." 
            },
            { 
                c: "Wissenschaft", 
                q: "Wie schnell ist Licht im Vakuum (ca.)?", 
                h1: "Es kÃ¶nnte die Erde in einer Sekunde mehrfach umrunden.", 
                h2: "Die Zahl ist knapp unter der 300.000er Marke.", 
                a: "299.792 km/s", 
                u: "km/s", 
                info: "Die Lichtgeschwindigkeit ist eine physikalische Konstante und die absolute Obergrenze fÃ¼r die Ãœbertragung von Informationen im Universum." 
            }
        ];

        let state = {
            currentStage: 0, 
            apiKey: '',
            category: 'all',
            difficulty: 'random', 
            currentLoadId: 0,
            currentQ: null,
            usedQuestions: [],
            isQuestionLoaded: false
        };

        // Init on load
        window.addEventListener('DOMContentLoaded', () => {
            populateCategories();
            const storedKey = localStorage.getItem('gemini_api_key');
            if(storedKey) {
                document.getElementById('startApiKeyInput').value = storedKey;
            }
            lucide.createIcons();
        });

        function populateCategories() {
            const options = `<option value="all">âœ¨ Alle Kategorien (Mix)</option><option disabled>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</option>` + 
                CATEGORIES.map(c => `<option value="${c}">${c}</option>`).join('');
            
            document.getElementById('categorySelect').innerHTML = options;
            document.getElementById('setupCategorySelect').innerHTML = options;
        }

        // --- INFO POPUP ---
        function showInfo(e) {
            if(e) e.stopPropagation(); 
            const modal = document.getElementById('info-modal');
            const content = document.getElementById('info-content');
            
            if (state.currentQ && state.currentQ.info) {
                content.innerText = state.currentQ.info;
            } else {
                content.innerText = "Keine zusÃ¤tzlichen Informationen verfÃ¼gbar.";
            }
            modal.classList.remove('hidden');
        }

        function closeInfo() {
            document.getElementById('info-modal').classList.add('hidden');
        }

        // --- API VERIFICATION ---

        async function verifyKeyOnly() {
            const key = document.getElementById('startApiKeyInput').value.trim();
            const btn = document.getElementById('btnVerify');
            const err = document.getElementById('apiErrorMsg');

            if(key.length < 10) {
                err.classList.remove('hidden');
                err.querySelector('span').innerText = "Key ist zu kurz";
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<div class="spinner"></div> PrÃ¼fe...';
            err.classList.add('hidden');

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: "Hi" }] }] })
                });

                if(response.ok) {
                    state.apiKey = key;
                    localStorage.setItem('gemini_api_key', key);
                    document.getElementById('apiKeyInput').value = key;

                    // Transition to Setup Modal
                    document.getElementById('start-modal').classList.add('hidden');
                    document.getElementById('setup-modal').classList.remove('hidden');
                    lucide.createIcons();
                } else {
                    throw new Error("Invalid Key");
                }
            } catch (e) {
                console.error(e);
                btn.disabled = false;
                btn.innerHTML = '<span>Weiter zum Setup</span><i data-lucide="arrow-right" class="w-5 h-5"></i>';
                err.classList.remove('hidden');
                err.querySelector('span').innerText = "Verbindung fehlgeschlagen. PrÃ¼fe den Key.";
                lucide.createIcons();
            }
        }

        function confirmSetupAndStart() {
            const cat = document.getElementById('setupCategorySelect').value;
            const diff = document.getElementById('setupDifficultySelect').value;
            
            document.getElementById('categorySelect').value = cat;
            document.getElementById('difficultySelect').value = diff;
            
            state.category = cat;
            state.difficulty = diff;

            const modal = document.getElementById('setup-modal');
            modal.classList.add('opacity-0', 'pointer-events-none');
            setTimeout(() => modal.style.display = 'none', 500);

            const game = document.getElementById('game-container');
            game.classList.remove('hidden');
            
            state.currentStage = 0;
            renderState(); 

            setTimeout(() => {
                game.classList.remove('opacity-0');
                fetchQuestion(); 
            }, 100);
        }

        function startOffline() {
            state.apiKey = '';
            document.getElementById('start-modal').style.display = 'none';
            document.getElementById('game-container').classList.remove('hidden');
            
            state.currentStage = 0;
            renderState();

            setTimeout(() => {
                document.getElementById('game-container').classList.remove('opacity-0');
                fetchQuestion(); 
            }, 100);
        }

        // --- UI FUNCTIONS ---

        function renderState() {
            const els = {
                h1: document.getElementById('box-h1'),
                h2: document.getElementById('box-h2'),
                ans: document.getElementById('box-ans'),
                infoBtn: document.getElementById('info-btn')
            };

            // Reset basics
            [els.h1, els.h2, els.ans].forEach(el => {
                el.className = 'reveal-box rounded-2xl p-1';
                el.querySelector('.overlay').style.display = 'flex';
                el.querySelector('.overlay').style.opacity = '1';
                el.querySelector('.content').style.opacity = '0';
                el.querySelector('.content').style.transform = 'translateY(1rem)';
            });
            els.ans.classList.remove('is-answer');
            els.infoBtn.classList.add('hidden'); 

            // If question is NOT loaded, everything is locked/loading
            if (!state.isQuestionLoaded) {
                [els.h1, els.h2, els.ans].forEach(el => el.classList.add('state-locked', 'state-loading'));
                return;
            }

            if (state.currentStage >= 1) setRevealed(els.h1);
            else setCovered(els.h1);

            if (state.currentStage >= 2) setRevealed(els.h2);
            else if (state.currentStage === 1) setCovered(els.h2);
            else setLocked(els.h2);

            if (state.currentStage >= 3) {
                setRevealed(els.ans);
                els.ans.classList.add('is-answer');
                setTimeout(() => els.infoBtn.classList.remove('hidden'), 300);
            } else if (state.currentStage === 2) setCovered(els.ans);
            else setLocked(els.ans);
            
            lucide.createIcons();
        }

        function setLocked(el) {
            el.classList.add('state-locked');
            el.classList.remove('state-loading');
            delete el.dataset.confirm;
            const span = el.querySelector('.overlay span');
            let text = 'Tipp 2';
            if(el.id === 'box-ans') text = 'Antwort';
            span.innerHTML = `<i data-lucide="lock" class="w-5 h-5"></i> ${text}`;
            span.classList.remove('text-yellow-400');
        }

        function setCovered(el) {
            el.classList.add('state-covered');
            el.classList.remove('state-loading');
            delete el.dataset.confirm;
            
            const span = el.querySelector('.overlay span');
            let iconName = 'lightbulb';
            let text = 'Tipp aufdecken';
            
            if(el.id === 'box-h1') { text = 'Tipp 1 aufdecken'; }
            else if(el.id === 'box-h2') { text = 'Tipp 2 aufdecken'; }
            else if(el.id === 'box-ans') { text = 'Antwort anzeigen'; iconName = 'eye'; }
            
            span.innerHTML = `<i data-lucide="${iconName}" class="w-5 h-5"></i> ${text}`;
            span.classList.remove('text-yellow-400');
        }

        function setRevealed(el) {
            el.classList.add('state-revealed');
            el.classList.remove('state-loading');
            el.querySelector('.overlay').style.opacity = '0';
            setTimeout(() => {
                el.querySelector('.overlay').style.display = 'none';
            }, 300);
            el.querySelector('.content').style.opacity = '1';
            el.querySelector('.content').style.transform = 'translateY(0)';
        }

        function handleInteraction(boxIndex) {
            // Prevent interaction if not loaded
            if (!state.isQuestionLoaded) return;

            if (state.currentStage > boxIndex - 1) return; 
            
            if (state.currentStage < boxIndex - 1) {
                const elId = boxIndex === 2 ? 'box-h2' : 'box-ans';
                const el = document.getElementById(elId);
                el.style.transform = 'translateX(5px)';
                setTimeout(() => el.style.transform = 'translateX(-5px)', 50);
                setTimeout(() => el.style.transform = 'translateX(5px)', 100);
                setTimeout(() => el.style.transform = 'translateX(0)', 150);
                return;
            }

            const elId = boxIndex === 1 ? 'box-h1' : (boxIndex === 2 ? 'box-h2' : 'box-ans');
            const el = document.getElementById(elId);

            if (el.dataset.confirm === 'true') {
                el.dataset.confirm = 'false';
                state.currentStage = boxIndex;
                renderState();
            } else {
                el.dataset.confirm = 'true';
                const span = el.querySelector('.overlay span');
                span.innerHTML = `<i data-lucide="check-circle" class="w-5 h-5"></i> BestÃ¤tigen?`;
                span.classList.add('text-yellow-400');
                lucide.createIcons();
            }
        }

        // --- GAME LOGIC ---

        async function fetchQuestion() {
            // START LOADING
            state.isQuestionLoaded = false;
            renderState(); // Locks everything

            const loader = document.getElementById('loading-overlay');
            loader.classList.remove('hidden');
            
            state.currentLoadId++;
            const myId = state.currentLoadId;

            let data = null;
            if (state.apiKey.length > 10) {
                data = await callGemini();
            }

            if (!data || state.currentLoadId !== myId) {
                if(state.currentLoadId !== myId) return;
                let pool = offlinePool;
                if(state.category !== 'all') pool = offlinePool.filter(i => i.c === state.category);
                if(pool.length === 0) pool = offlinePool;
                
                // Avoid duplicates in offline pool
                let available = pool.filter(q => !state.usedQuestions.includes(q.q));
                if (available.length === 0) {
                    available = pool; 
                    state.usedQuestions = []; 
                }
                
                data = available[Math.floor(Math.random() * available.length)];
                document.getElementById('liveBadge').classList.add('hidden');
            } else {
                document.getElementById('liveBadge').classList.remove('hidden');
            }

            state.currentQ = data;
            state.usedQuestions.push(data.q);

            document.getElementById('questionText').innerText = data.q;
            document.getElementById('questionUnit').innerText = data.u || "Einheit"; 
            document.getElementById('text-h1').innerText = data.h1 || "Kein Tipp verfÃ¼gbar";
            document.getElementById('text-h2').innerText = data.h2 || "Kein Tipp verfÃ¼gbar";
            document.getElementById('text-ans').innerText = data.a;
            
            // FINISH LOADING
            state.isQuestionLoaded = true;
            renderState(); // Unlocks Tip 1 (covered)

            document.getElementById('categoryBadge').innerText = data.c || state.category;
            document.getElementById('difficultyBadge').innerText = state.difficulty === 'random' ? 'Zufall' : state.difficulty;

            loader.classList.add('hidden');
        }

        async function callGemini() {
            try {
                const diffMap = { 'leicht': 'Einfach', 'mittel': 'Mittel', 'schwer': 'Schwer', 'experte': 'Extrem' };
                let selectedDiff = state.difficulty;
                
                // Handle Random Difficulty
                if (selectedDiff === 'random') {
                    const diffs = ['leicht', 'mittel', 'schwer', 'experte'];
                    selectedDiff = diffs[Math.floor(Math.random() * diffs.length)];
                }

                const cat = state.category === 'all' ? CATEGORIES[Math.floor(Math.random() * CATEGORIES.length)] : state.category;
                
                const history = state.usedQuestions.slice(-15).join("; ");

                const prompt = `Erstelle eine SchÃ¤tzfrage.
                Kategorie: "${cat}".
                Schwierigkeit: ${diffMap[selectedDiff]}.
                Antwort muss eine Zahl/GrÃ¶ÃŸe sein.

                VERMEIDE WIEDERHOLUNGEN:
                Folgende Fragen/Themen wurden kÃ¼rzlich gestellt - erstelle NICHTS Ã„hnliches:
                ${history}

                VERMEIDE SPOILER IN DER FRAGE:
                Nenne KEINE Zahlen/Daten in der Frage, die eine Berechnung der LÃ¶sung ermÃ¶glichen.

                Generiere 2 intelligente Tipps (h1, h2) mit steigender Genauigkeit:

                TIPP 1 (VAGE & GROB):
                - Nur die grobe GrÃ¶ÃŸenordnung oder ein sehr weiter Vergleich.
                - Soll die Richtung weisen, aber viel Spielraum lassen.

                TIPP 2 (KONKRETER & EINGRENZEND):
                - Ein genauerer Vergleich oder eine engere Eingrenzung.
                - Nutze bekannte Objekte/Fakten als Referenz.

                REGELN FÃœR BEIDE TIPPS:
                1. SPOILER-SCHUTZ: Die LÃ¶sungszahl darf in den Tipps NICHT vorkommen.
                2. SPIELRAUM LASSEN: Die Tipps dÃ¼rfen NIEMALS die exakte LÃ¶sung umschreiben (z.B. "Genau wie 2 Marathons" bei 84km ist VERBOTEN). Es muss "Mehr als..." oder "Weniger als..." sein.
                3. KEINE RECHENAUFGABEN: Keine "Mal", "Geteilt", "Minus" Aufgaben.
                4. EINZEL-FAKT: Jeder Tipp darf nur EINEN einzigen Vergleich oder Fakt enthalten. Keine Doppel-Infos.
                5. WAHRHEITS-CHECK: PrÃ¼fe deine Vergleiche mathematisch, bevor du sie ausgibst!

                FÃ¼ge ein Feld 'info' hinzu mit einem interessanten Fakt ("Fun Fact"), der die Antwort erklÃ¤rt.

                JSON Format: { "q": "Fragetext?", "h1": "Vager Tipp 1", "h2": "Konkreter Tipp 2", "a": "LÃ¶sung (Zahl+Einheit)", "u": "Einheit", "info": "Spannender Fakt zur LÃ¶sung" }`;

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${state.apiKey}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                
                if (!response.ok) return null;
                const json = await response.json();
                const txt = json.candidates[0].content.parts[0].text;
                const cleanJson = txt.substring(txt.indexOf('{'), txt.lastIndexOf('}') + 1);
                const parsed = JSON.parse(cleanJson);
                return { c: cat, ...parsed };
            } catch (e) {
                console.error(e);
                return null;
            }
        }

        function nextQuestion() {
            const btn = document.getElementById('btn-next');
            
            if (btn.dataset.confirm === 'true') {
                btn.dataset.confirm = 'false';
                
                btn.innerHTML = 'NÃ¤chste Frage <i data-lucide="arrow-right" class="w-5 h-5"></i>';
                btn.className = "btn-primary w-full py-4 rounded-xl font-bold text-lg shadow-lg flex items-center justify-center gap-2 text-white";
                
                state.currentStage = 0;
                renderState();
                fetchQuestion();
                lucide.createIcons();
            } else {
                btn.dataset.confirm = 'true';
                btn.innerHTML = 'Wirklich weiter? <i data-lucide="help-circle" class="w-5 h-5"></i>';
                btn.className = "btn-confirm w-full py-4 rounded-xl font-bold text-lg shadow-lg flex items-center justify-center gap-2 text-white";
                lucide.createIcons();
            }
        }

        function toggleSettings() {
            const m = document.getElementById('settings-modal');
            m.classList.toggle('hidden');
            if(!m.classList.contains('hidden')) {
                document.getElementById('apiKeyInput').value = state.apiKey;
            }
        }

        function updateSettings(type) {
            if(type === 'category') {
                state.category = document.getElementById('categorySelect').value;
            }
            if(type === 'difficulty') {
                state.difficulty = document.getElementById('difficultySelect').value;
            }
        }

        function saveSettings() {
            const newKey = document.getElementById('apiKeyInput').value.trim();
            if(newKey !== state.apiKey) {
                state.apiKey = newKey;
                localStorage.setItem('gemini_api_key', newKey);
            }
            toggleSettings();
        }

        lucide.createIcons();

    </script>
</body>
</html>


