<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Das Duell um die Geld</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* Slate 900 */
            color: #e2e8f0; /* Slate 200 */
            /* Mobile: Allow scrolling default */
            overflow-y: auto; 
            overflow-x: hidden;
            height: 100%;
            -webkit-tap-highlight-color: transparent;
        }

        /* Desktop: Fix to viewport (App-Feeling) */
        @media (min-width: 1024px) {
            body {
                height: 100dvh;
                overflow: hidden;
            }
        }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 2px; }

        .fade-in { animation: fadeIn 0.4s ease-out; }
        .slide-up { animation: slideUp 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .glass-panel {
            background: rgba(30, 41, 59, 0.85);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Buttons */
        .btn-primary { background: linear-gradient(135deg, #3b82f6, #2563eb); transition: transform 0.1s, filter 0.2s; }
        .btn-primary:active { transform: scale(0.97); }

        .btn-confirm { background: linear-gradient(135deg, #d97706, #b45309); transition: transform 0.1s, filter 0.2s; }
        .btn-confirm:active { transform: scale(0.97); }

        .btn-secondary { background: rgba(51, 65, 85, 0.5); border: 1px solid rgba(255, 255, 255, 0.1); transition: all 0.2s; }
        .btn-secondary:active { background: rgba(51, 65, 85, 0.8); }

        .btn-info { background: rgba(16, 185, 129, 0.15); border: 1px solid rgba(16, 185, 129, 0.4); color: #34d399; transition: all 0.2s; }
        .btn-info:active { transform: scale(0.95); background: rgba(16, 185, 129, 0.25); }

        /* Reveal Box */
        .reveal-box { transition: all 0.3s ease; }
        
        .state-locked { opacity: 0.5; filter: grayscale(100%); cursor: not-allowed; background: rgba(15, 23, 42, 0.4); border: 1px solid rgba(255,255,255,0.05); }
        .state-loading { opacity: 0.4; pointer-events: none; filter: grayscale(80%); }
        .state-covered { cursor: pointer; background: rgba(30, 41, 59, 0.4); border: 1px dashed #3b82f6; }
        .state-covered:active { background: rgba(30, 41, 59, 0.8); transform: scale(0.99); }
        .state-confirming { background: rgba(59, 130, 246, 0.1); border: 1px solid #eab308; }
        .state-revealed { background: rgba(30, 41, 59, 0.9); border: 1px solid rgba(255,255,255,0.2); cursor: default; }
        .state-revealed.is-answer { background: rgba(22, 101, 52, 0.2); border-color: rgba(34, 197, 94, 0.5); }

        .custom-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2394a3b8' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }

        .spinner { width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="flex flex-col bg-[#0f172a]">

    <header class="flex-none w-full flex justify-between items-center p-3 bg-slate-900/80 border-b border-slate-800 z-20 backdrop-blur-md sticky top-0">
        <div class="flex items-center gap-2">
            <div class="bg-blue-600/20 p-2 rounded-xl">
                <i data-lucide="brain-circuit" class="w-5 h-5 text-blue-400"></i>
            </div>
            <h1 class="font-bold text-lg text-slate-100 tracking-tight">Das Duell um die Geld</h1>
        </div>
        <button onclick="toggleSettings()" class="p-2 rounded-xl bg-slate-800 hover:bg-slate-700 text-slate-300 border border-slate-700">
            <i data-lucide="settings-2" class="w-5 h-5"></i>
        </button>
    </header>

    <main class="flex-1 relative w-full max-w-7xl mx-auto p-3 lg:p-6">
        <div id="start-modal" class="fixed inset-0 z-[60] bg-slate-950 flex items-center justify-center p-4 fade-in">
            <div class="glass-panel w-full max-w-md rounded-2xl shadow-2xl flex flex-col border border-slate-700 p-8 relative">
                <div class="relative z-10 text-center">
                    <h2 class="text-2xl font-bold text-white mb-2">Willkommen!</h2>
                    <p class="text-slate-400 text-sm mb-4">Bitte API Key eingeben.</p>
                    <input type="password" id="startApiKeyInput" class="w-full bg-slate-900 border border-slate-700 text-white rounded-xl p-3 mb-4" placeholder="AIzaSy...">
                    <button onclick="verifyKeyOnly()" id="btnVerify" class="btn-primary w-full py-3 rounded-xl font-bold text-white mb-4">Weiter</button>
                    <button onclick="startOffline()" class="btn-secondary w-full py-3 rounded-xl text-slate-300 text-sm">Offline Modus</button>
                    <p id="apiErrorMsg" class="text-red-400 text-xs mt-2 hidden">Fehler</p>
                </div>
            </div>
        </div>

        <div id="setup-modal" class="hidden fixed inset-0 z-[60] bg-slate-950 flex items-center justify-center p-4 fade-in">
            <div class="glass-panel w-full max-w-md rounded-2xl shadow-2xl flex flex-col border border-slate-700 p-8">
                <h2 class="text-xl font-bold text-white mb-4 text-center">Setup</h2>
                <div class="space-y-4">
                    <select id="setupCategorySelect" class="custom-select w-full bg-slate-900 border border-slate-700 text-white rounded-xl p-3"></select>
                    <select id="setupDifficultySelect" class="custom-select w-full bg-slate-900 border border-slate-700 text-white rounded-xl p-3">
                        <option value="random" selected>üé≤ Zuf√§llig</option>
                        <option value="leicht">üü¢ Leicht</option>
                        <option value="mittel">üü° Mittel</option>
                        <option value="schwer">üî¥ Schwer</option>
                        <option value="experte">üü£ Experte</option>
                    </select>
                    <button onclick="confirmSetupAndStart()" class="btn-primary w-full py-3 rounded-xl font-bold text-white">Starten</button>
                </div>
            </div>
        </div>

        <div id="settings-modal" class="hidden fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4 fade-in backdrop-blur-sm">
            <div class="glass-panel w-full max-w-md rounded-2xl border border-slate-700 p-6">
                <h2 class="text-lg font-bold text-white mb-4">Einstellungen</h2>
                <input type="password" id="apiKeyInput" class="w-full bg-slate-900 border border-slate-700 text-white rounded-lg p-3 mb-4" placeholder="API Key">
                <div class="mb-4">
                    <label class="block text-xs text-slate-400 mb-1">Ansicht</label>
                    <select id="viewModeSelect" onchange="updateViewMode()" class="custom-select w-full bg-slate-900 border border-slate-700 text-white rounded-lg p-3">
                        <option value="auto">‚ú® Automatisch</option>
                        <option value="mobile">üì± Immer Mobile</option>
                        <option value="desktop">üñ•Ô∏è Immer Desktop</option>
                    </select>
                </div>
                <button onclick="saveSettings()" class="w-full py-3 rounded-xl bg-blue-600 text-white font-bold">Speichern</button>
            </div>
        </div>

        <div id="info-modal" class="hidden fixed inset-0 z-[70] bg-slate-950/90 flex items-center justify-center p-4 fade-in backdrop-blur-sm">
            <div class="glass-panel w-full max-w-lg rounded-2xl border border-slate-700 p-6 relative max-h-[80vh] flex flex-col">
                <div class="flex justify-between items-start mb-2 flex-none">
                    <h3 class="text-xl font-bold text-white"><i data-lucide="info" class="inline w-5 h-5 text-green-400"></i> Info</h3>
                    <button onclick="closeInfo()" class="text-slate-400"><i data-lucide="x"></i></button>
                </div>
                <div id="info-content" class="text-slate-300 overflow-y-auto custom-scrollbar flex-1 pr-2"></div>
            </div>
        </div>

        <!-- GAME GRID -->
        <div id="game-container" class="hidden opacity-0 transition-opacity duration-500 w-full h-full lg:grid lg:grid-cols-12 lg:gap-6 flex flex-col gap-4 pb-10 lg:pb-0">
            
            <!-- LEFT COLUMN (Controls + Question) -->
            <div id="col-left" class="lg:col-span-5 flex flex-col gap-4 lg:h-full lg:min-h-0">
                
                <!-- In-Game Controls -->
                <div class="glass-panel p-3 rounded-xl border border-slate-700 flex gap-2 shadow-lg flex-none">
                    <select id="categorySelect" onchange="updateSettings('category')" class="custom-select flex-1 bg-slate-800 border-slate-600 text-white text-xs rounded-lg p-2"></select>
                    <select id="difficultySelect" onchange="updateSettings('difficulty')" class="custom-select flex-1 bg-slate-800 border-slate-600 text-white text-xs rounded-lg p-2">
                        <option value="random">üé≤ Zufall</option>
                        <option value="leicht">üü¢ Leicht</option>
                        <option value="mittel">üü° Mittel</option>
                        <option value="schwer">üî¥ Schwer</option>
                        <option value="experte">üü£ Experte</option>
                    </select>
                </div>

                <!-- QUESTION CARD -->
                <div class="relative flex-col flex lg:flex-1 lg:min-h-0">
                    <div id="loading-overlay" class="hidden absolute inset-0 z-30 flex flex-col items-center justify-center bg-slate-900/90 backdrop-blur-sm rounded-3xl">
                        <div class="spinner mb-4"></div>
                        <div class="text-blue-400 font-bold animate-pulse">Lade...</div>
                    </div>

                    <div class="glass-panel rounded-2xl p-4 md:p-8 shadow-2xl relative overflow-hidden flex flex-col lg:h-full">
                        <div class="flex flex-wrap items-center gap-2 mb-4 flex-none">
                            <span id="categoryBadge" class="px-2 py-1 bg-blue-500/10 text-blue-300 rounded text-[10px] font-bold uppercase border border-blue-500/20">...</span>
                            <span id="difficultyBadge" class="px-2 py-1 bg-orange-500/10 text-orange-300 rounded text-[10px] font-bold uppercase border border-orange-500/20">...</span>
                            <span id="liveBadge" class="hidden px-2 py-1 bg-green-500/10 text-green-300 rounded text-[10px] font-bold uppercase border border-green-500/20 flex items-center gap-1"><i data-lucide="zap" class="w-3 h-3"></i> AI</span>
                        </div>

                        <!-- Mobile: Auto height, Desktop: Scrollable if needed -->
                        <div class="lg:flex-1 lg:overflow-y-auto custom-scrollbar lg:pr-2 flex flex-col justify-center">
                            <h2 id="questionText" class="font-bold text-white leading-tight drop-shadow-lg text-xl md:text-2xl transition-all">Lade Frage...</h2>
                        </div>
                        
                        <div class="flex-none mt-4 pt-2 border-t border-slate-700/50">
                            <span class="text-slate-400 text-xs font-bold uppercase tracking-widest">Gesucht: <span id="questionUnit" class="text-blue-300">...</span></span>
                        </div>
                    </div>
                </div>

                <div id="wrap-btn-desktop" class="hidden lg:block flex-none">
                    <button id="btn-next-desktop" onclick="nextQuestion()" class="btn-primary w-full py-3 rounded-xl font-bold text-lg shadow-lg text-white">
                        N√§chste Frage <i data-lucide="arrow-right" class="inline w-5 h-5"></i>
                    </button>
                </div>
            </div>

            <!-- RIGHT COLUMN (Hints) -->
            <div id="col-right" class="lg:col-span-7 flex flex-col gap-4 lg:h-full lg:min-h-0 lg:overflow-y-auto custom-scrollbar">
                
                <!-- HINT 1 -->
                <div id="box-h1" class="reveal-box state-covered rounded-xl p-1 flex-1 min-h-[100px] flex flex-col" onclick="handleInteraction(1)">
                    <div class="relative rounded-lg w-full h-full flex items-center justify-center overflow-hidden bg-slate-800/50 min-h-[inherit]">
                        <div class="overlay absolute inset-0 flex items-center justify-center z-10 bg-slate-800/90 transition-opacity">
                            <span class="flex items-center gap-2 font-bold text-blue-400"><i data-lucide="lightbulb"></i> Tipp 1</span>
                        </div>
                        <div class="content w-full h-full p-4 lg:p-6 overflow-y-auto custom-scrollbar text-center flex items-center justify-center opacity-0 transition-opacity">
                            <span id="text-h1" class="text-slate-200 font-medium">...</span>
                        </div>
                    </div>
                </div>

                <!-- HINT 2 -->
                <div id="box-h2" class="reveal-box state-locked rounded-xl p-1 flex-1 min-h-[100px] flex flex-col" onclick="handleInteraction(2)">
                    <div class="relative rounded-lg w-full h-full flex items-center justify-center overflow-hidden bg-slate-800/50 min-h-[inherit]">
                        <div class="overlay absolute inset-0 flex items-center justify-center z-10 bg-slate-900/50">
                            <span class="flex items-center gap-2 font-bold text-slate-500"><i data-lucide="lock"></i> Tipp 2</span>
                        </div>
                        <div class="content w-full h-full p-4 lg:p-6 overflow-y-auto custom-scrollbar text-center flex items-center justify-center opacity-0 transition-opacity">
                            <span id="text-h2" class="text-slate-200 font-medium">...</span>
                        </div>
                    </div>
                </div>

                <!-- ANSWER -->
                <div id="box-ans" class="reveal-box state-locked rounded-xl p-1 flex-1 min-h-[100px] flex flex-col" onclick="handleInteraction(3)">
                    <div class="relative rounded-lg w-full h-full flex items-center justify-center overflow-hidden bg-slate-800/50 min-h-[inherit]">
                        <div class="overlay absolute inset-0 flex items-center justify-center z-10 bg-slate-900/50">
                            <span class="flex items-center gap-2 font-bold text-slate-500"><i data-lucide="lock"></i> Antwort</span>
                        </div>
                        <div class="content w-full h-full p-4 lg:p-6 text-center flex flex-col items-center justify-center opacity-0 transition-opacity relative">
                            <div class="text-[10px] uppercase tracking-widest text-green-400 font-bold mb-1">L√∂sung</div>
                            <div id="text-ans" class="text-3xl font-black text-white">...</div>
                            <button onclick="showInfo(event)" id="info-btn" class="absolute right-2 top-1/2 -translate-y-1/2 btn-info p-2 rounded-full hidden"><i data-lucide="info" class="w-5 h-5"></i></button>
                        </div>
                    </div>
                </div>

                <div id="wrap-btn-mobile" class="lg:hidden flex-none pb-8">
                    <button id="btn-next-mobile" onclick="nextQuestion()" class="btn-primary w-full py-3 rounded-xl font-bold text-lg shadow-lg text-white mb-6">
                        N√§chste Frage <i data-lucide="arrow-right" class="inline w-5 h-5"></i>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <script>
        const safeStorage = {
            getItem: (k) => { try { return localStorage.getItem(k); } catch(e) { return null; } },
            setItem: (k, v) => { try { localStorage.setItem(k, v); } catch(e) {} }
        };

        const CATEGORIES = ["Allgemeines", "Geschichte", "Natur", "Geografie", "S√ºdtirol", "Universum", "Wissenschaft", "Games", "Promis", "Lustiges", "Sport", "Technik", "Film", "Tiere", "Musik", "Essen", "Kunst", "Wirtschaft", "Architektur", "Literatur"];
        const offlinePool = [
            { c: "S√ºdtirol", q: "Wie hoch ist der Ortler?", h1: "Er ist der h√∂chste Berg S√ºdtirols.", h2: "Er ist etwas niedriger als der Mont Blanc.", a: "3.905 Meter", u: "Meter", info: "Der Ortler ist der h√∂chste Berg der italienischen Provinz S√ºdtirol und der Region Trentino-S√ºdtirol. Er wurde erstmals 1804 bestiegen." },
            { c: "Games", q: "Wann erschien Super Mario Bros. (Japan)?", h1: "Es war im Jahrzehnt der Neonfarben.", h2: "Im selben Jahr gewann Boris Becker Wimbledon.", a: "1985", u: "Jahr", info: "Super Mario Bros. revolutionierte das Jump-‚Äôn‚Äô-Run-Genre und rettete den Videospielmarkt nach dem 'Video Game Crash' von 1983." },
            { c: "Natur", q: "Wie viele Beine hat ein Tausendf√º√üler (Rekord)?", h1: "Der Name ist eine √úbertreibung.", h2: "Der Rekord liegt bei ca. 750.", a: "750", u: "Beine", info: "Illacme plenipes h√§lt den Rekord." }
        ];

        let state = { currentStage: 0, apiKey: '', category: 'all', difficulty: 'random', currentLoadId: 0, currentQ: null, usedQuestions: [], isQuestionLoaded: false, viewMode: 'auto', confirmNext: false };

        window.addEventListener('DOMContentLoaded', () => {
            populateCategories();
            const storedKey = safeStorage.getItem('gemini_api_key');
            if(storedKey) {
                document.getElementById('startApiKeyInput').value = storedKey;
                document.getElementById('apiKeyInput').value = storedKey;
                state.apiKey = storedKey;
            }
            const storedView = safeStorage.getItem('view_mode');
            if(storedView) {
                state.viewMode = storedView;
                document.getElementById('viewModeSelect').value = storedView;
            }
            lucide.createIcons();
            
            // Initial apply
            applyViewMode();
            window.addEventListener('resize', applyViewMode);
        });

        function populateCategories() {
            const opts = `<option value="all">‚ú® Alle</option><option disabled>‚îÄ‚îÄ</option>` + CATEGORIES.map(c => `<option value="${c}">${c}</option>`).join('');
            document.getElementById('categorySelect').innerHTML = opts;
            document.getElementById('setupCategorySelect').innerHTML = opts;
        }

        function resizeText(elId, type) {
            const el = document.getElementById(elId);
            if(!el) return;
            const text = el.innerText;
            const len = text.length;
            el.className = type === 'q' ? "font-bold text-white leading-tight drop-shadow-lg transition-all" : "text-slate-200 font-medium transition-all";
            if (type === 'q') {
                if(len < 80) el.classList.add('text-xl', 'md:text-3xl');
                else if(len < 150) el.classList.add('text-lg', 'md:text-2xl');
                else el.classList.add('text-base', 'md:text-xl');
            } else if (type === 'h') {
                if(len < 100) el.classList.add('text-lg');
                else if(len < 200) el.classList.add('text-base');
                else el.classList.add('text-sm');
            }
        }

        window.showInfo = function(e) { 
            if(e) e.stopPropagation(); 
            document.getElementById('info-content').innerText = state.currentQ?.info || "Keine Info"; 
            document.getElementById('info-modal').classList.remove('hidden'); 
        }

        window.closeInfo = function() { 
            document.getElementById('info-modal').classList.add('hidden'); 
        }

        window.toggleSettings = function() { 
            document.getElementById('settings-modal').classList.toggle('hidden'); 
            if(!document.getElementById('settings-modal').classList.contains('hidden')) 
                document.getElementById('apiKeyInput').value = state.apiKey; 
        }

        window.updateSettings = function(t) { 
            if(t==='category') state.category = document.getElementById('categorySelect').value; 
            if(t==='difficulty') state.difficulty = document.getElementById('difficultySelect').value; 
        }

        window.saveSettings = function() { 
            state.apiKey = document.getElementById('apiKeyInput').value.trim(); 
            safeStorage.setItem('gemini_api_key', state.apiKey); 
            updateViewMode(); 
            toggleSettings(); 
        }

        window.confirmSetupAndStart = function() { 
            state.category = document.getElementById('setupCategorySelect').value;
            state.difficulty = document.getElementById('setupDifficultySelect').value;
            document.getElementById('categorySelect').value = state.category;
            document.getElementById('difficultySelect').value = state.difficulty;
            document.getElementById('setup-modal').classList.add('hidden'); 
            document.getElementById('game-container').classList.remove('hidden', 'opacity-0');
            applyViewMode(); 
            fetchQuestion(); 
        }

        window.startOffline = function() { 
            state.apiKey=''; 
            document.getElementById('start-modal').classList.add('hidden'); 
            document.getElementById('game-container').classList.remove('hidden', 'opacity-0'); 
            applyViewMode(); 
            fetchQuestion(); 
        }
        
        window.updateViewMode = function() {
            state.viewMode = document.getElementById('viewModeSelect').value;
            safeStorage.setItem('view_mode', state.viewMode);
            applyViewMode();
        }

        function applyViewMode() {
            const cont = document.getElementById('game-container');
            const left = document.getElementById('col-left');
            const right = document.getElementById('col-right');
            const btnD = document.getElementById('wrap-btn-desktop');
            const btnM = document.getElementById('wrap-btn-mobile');
            
            // Use window innerWidth for auto
            const isDesktop = state.viewMode === 'desktop' || (state.viewMode === 'auto' && window.innerWidth >= 1024);

            cont.className = "hidden opacity-0 w-full h-full transition-opacity duration-500";
            
            if (!isDesktop) {
                // MOBILE LAYOUT
                document.body.style.overflowY = 'auto'; // Enable scroll
                cont.classList.add('flex', 'flex-col', 'gap-4', 'pb-10');
                left.className = "flex flex-col gap-4 min-h-0"; // Let it grow
                right.className = "flex flex-col gap-4 min-h-0"; // Let it grow
                
                btnD.classList.add('hidden');
                btnD.classList.remove('block');
                btnM.classList.remove('hidden');
            } else {
                // DESKTOP LAYOUT (Fixed)
                document.body.style.overflowY = 'hidden'; // Disable scroll
                cont.classList.add('grid', 'grid-cols-12', 'gap-6');
                left.className = "col-span-5 flex flex-col gap-4 h-full min-h-0";
                right.className = "col-span-7 flex flex-col gap-4 h-full min-h-0 overflow-y-auto custom-scrollbar";
                
                btnD.classList.remove('hidden');
                btnD.classList.add('block');
                btnM.classList.add('hidden');
            }
            
            if(state.isQuestionLoaded) cont.classList.remove('hidden', 'opacity-0');
        }

        window.verifyKeyOnly = async function() {
            const key = document.getElementById('startApiKeyInput').value.trim();
            if(key.length < 10) {
                document.getElementById('apiErrorMsg').classList.remove('hidden');
                document.getElementById('apiErrorMsg').innerText = "Key zu kurz";
                return;
            }
            document.getElementById('btnVerify').disabled = true;
            try {
                const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ contents: [{ parts: [{ text: "Hi" }] }] })
                });
                if(r.ok) {
                    state.apiKey = key;
                    safeStorage.setItem('gemini_api_key', key);
                    document.getElementById('apiKeyInput').value = key;
                    document.getElementById('start-modal').classList.add('hidden');
                    document.getElementById('setup-modal').classList.remove('hidden');
                } else throw new Error();
            } catch(e) {
                document.getElementById('btnVerify').disabled = false;
                document.getElementById('apiErrorMsg').classList.remove('hidden');
                document.getElementById('apiErrorMsg').innerText = "Fehler bei Verbindung";
            }
        }

        async function fetchQuestion() {
            state.isQuestionLoaded = false;
            state.currentStage = 0; // RESET STAGE immediately
            state.confirmNext = false;
            
            renderState(); // Shows locked state because isQuestionLoaded=false
            updateNextButtons(false);
            document.getElementById('loading-overlay').classList.remove('hidden');
            
            state.currentLoadId++;
            const myId = state.currentLoadId;
            let data = null;

            if (state.apiKey.length > 10) data = await callGemini();
            
            if (!data || state.currentLoadId !== myId) {
                if(state.currentLoadId !== myId) return;
                let pool = offlinePool.filter(q => !state.usedQuestions.includes(q.q));
                if (pool.length === 0) { pool = offlinePool; state.usedQuestions = []; }
                data = pool[Math.floor(Math.random() * pool.length)];
                document.getElementById('liveBadge').classList.add('hidden');
            } else {
                document.getElementById('liveBadge').classList.remove('hidden');
            }

            state.currentQ = data;
            state.usedQuestions.push(data.q);

            const qEl = document.getElementById('questionText');
            qEl.innerText = data.q;
            resizeText('questionText', 'q');
            document.getElementById('questionUnit').innerText = data.u || "";
            document.getElementById('text-h1').innerText = data.h1;
            resizeText('text-h1', 'h');
            document.getElementById('text-h2').innerText = data.h2;
            resizeText('text-h2', 'h');
            document.getElementById('text-ans').innerText = data.a;

            state.isQuestionLoaded = true;
            state.currentStage = 0; // Ensure reset for rendering
            renderState();
            
            document.getElementById('categoryBadge').innerText = data.c || state.category;
            document.getElementById('difficultyBadge').innerText = state.difficulty === 'random' ? 'Zufall' : state.difficulty;
            
            document.getElementById('loading-overlay').classList.add('hidden');
            applyViewMode();
        }

        async function callGemini() {
            try {
                const diffs = { 'leicht': 'Einfach', 'mittel': 'Mittel', 'schwer': 'Schwer', 'experte': 'Extrem' };
                let d = state.difficulty === 'random' ? ['leicht','mittel','schwer','experte'][Math.floor(Math.random()*4)] : state.difficulty;
                const c = state.category === 'all' ? CATEGORIES[Math.floor(Math.random()*CATEGORIES.length)] : state.category;
                
                const prompt = `Erstelle eine Sch√§tzfrage f√ºr Kategorie "${c}". Schwierigkeit: ${diffs[d]}.
                Antwort: Konkrete Zahl/Gr√∂√üe.
                KEINE Fragen zu Datenspeicher oder langweiligen Verbrauchsstatistiken.
                VERBOTEN: Rechenaufgaben in Tipps! Vermeide Sammelfragen.
                Frage nach spezifischen, einzelnen Objekten (z.B. "Gewicht des Space Shuttle Columbia").

                TIPP 1 (Kopfkino): Erzeuge ein Bild im Kopf. 
                REGELN:
                1. KEINE Zahlenwerte des Vergleichsobjekts in Klammern nennen!
                2. KEINE Multiplikatoren ("3x so hoch").
                3. Nur EINEN einzigen Vergleichssatz. Keine "Zwischen A und B" S√§tze.
                4. VERBOTEN: "Stell dir vor...", "Denk an...".

                TIPP 2 (Konkret): Ein Vergleichsobjekt.
                REGELN:
                1. KEINE Zahlenwerte in Klammern! (VERBOTEN: "(ca. 300m)")
                2. Keine Rechenaufgabe.
                3. Nur EINEN einzigen Fakt nennen.
                
                JSON: { "q": "Frage", "h1": "Kreativer Tipp 1", "h2": "Konkreter Tipp 2", "a": "L√∂sung", "u": "Einheit", "info": "Fun Fact" }`;

                const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${state.apiKey}`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const j = await r.json();
                const t = j.candidates[0].content.parts[0].text;
                return JSON.parse(t.substring(t.indexOf('{'), t.lastIndexOf('}')+1));
            } catch(e) { return null; }
        }

        function renderState() {
            const els = { h1: document.getElementById('box-h1'), h2: document.getElementById('box-h2'), ans: document.getElementById('box-ans'), info: document.getElementById('info-btn') };
            [els.h1, els.h2, els.ans].forEach(e => {
                e.querySelector('.overlay').style.display = 'flex';
                e.querySelector('.overlay').style.opacity = '1';
                e.querySelector('.content').style.opacity = '0';
            });
            els.ans.classList.remove('is-answer');
            els.info.classList.add('hidden');

            if(!state.isQuestionLoaded) {
                [els.h1, els.h2, els.ans].forEach(el => el.className = "reveal-box state-locked state-loading rounded-xl p-1 flex-1 min-h-[100px] flex flex-col");
                return;
            }

            const updateBox = (el, stageReq) => {
                const ov = el.querySelector('.overlay');
                const co = el.querySelector('.content');
                if (state.currentStage >= stageReq) {
                    el.className = "reveal-box state-revealed rounded-xl p-1 flex-1 min-h-[100px] flex flex-col";
                    ov.style.opacity = '0';
                    setTimeout(() => ov.style.display = 'none', 300);
                    co.style.opacity = '1';
                } else if (state.currentStage === stageReq - 1) {
                    el.className = "reveal-box state-covered rounded-xl p-1 flex-1 min-h-[100px] flex flex-col";
                } else {
                    el.className = "reveal-box state-locked rounded-xl p-1 flex-1 min-h-[100px] flex flex-col";
                    const span = ov.querySelector('span');
                    if(el.id.includes('ans')) span.innerHTML = '<i data-lucide="lock"></i> Antwort';
                    else span.innerHTML = `<i data-lucide="lock"></i> Tipp ${stageReq}`;
                    span.classList.remove('text-yellow-400');
                    delete el.dataset.confirm;
                }
            };
            updateBox(els.h1, 1); updateBox(els.h2, 2); updateBox(els.ans, 3);
            if (state.currentStage >= 3) {
                els.ans.classList.add('is-answer');
                setTimeout(() => els.info.classList.remove('hidden'), 300);
            }
            lucide.createIcons();
        }

        window.handleInteraction = function(idx) {
            if (!state.isQuestionLoaded || state.currentStage > idx - 1) return;
            if (state.currentStage < idx - 1) return; 
            const el = document.getElementById(idx===1?'box-h1':idx===2?'box-h2':'box-ans');
            if (el.dataset.confirm === 'true') {
                el.dataset.confirm = 'false';
                state.currentStage = idx;
                renderState();
            } else {
                el.dataset.confirm = 'true';
                el.querySelector('.overlay span').innerHTML = '<i data-lucide="check-circle"></i> Best√§tigen?';
                el.querySelector('.overlay span').classList.add('text-yellow-400');
                lucide.createIcons();
            }
        };

        window.nextQuestion = function() {
            if (state.confirmNext) {
                state.confirmNext = false;
                fetchQuestion();
                updateNextButtons(false);
            } else {
                state.confirmNext = true;
                updateNextButtons(true);
            }
        };

        function updateNextButtons(confirm) {
            ['btn-next-desktop', 'btn-next-mobile'].forEach(id => {
                const btn = document.getElementById(id);
                if(btn) {
                    btn.innerHTML = confirm ? 'Sicher? <i data-lucide="help-circle" class="inline w-5 h-5"></i>' : 'N√§chste Frage <i data-lucide="arrow-right" class="inline w-5 h-5"></i>';
                    btn.className = confirm ? "btn-confirm w-full py-4 rounded-xl font-bold text-lg shadow-lg text-white mb-6 lg:mb-0" : "btn-primary w-full py-4 rounded-xl font-bold text-lg shadow-lg text-white mb-6 lg:mb-0";
                }
            });
            lucide.createIcons();
        }
    </script>
</body>
</html>
